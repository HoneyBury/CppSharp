# 工作流的名称，会显示在 GitHub 的 "Actions" 页面上
name: Create Project Release

# 触发条件
on:
  push:
    tags:
      - 'v*'

jobs:
  create-release-assets:
    name: Build, Document, and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 步骤 1: 检出代码
      - name: Checkout repository code
        uses: actions/checkout@v4

      # 步骤 2: 安装 Pandoc 和完整的 LaTeX 环境 (已修正)
      # 这里安装了 texlive-latex-recommended 和 texlive-latex-extra，
      # 它们包含了 xcolor.sty 以及其他常用宏包。
      - name: Install Pandoc and a more complete LaTeX distribution
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-recommended texlive-latex-extra lmodern

      # 步骤 3: 提取版本号并进行校验
      - name: Extract and Verify Version
        id: version_check
        run: |
          TAG_NAME=${{ github.ref_name }}
          echo "Git Tag: ${TAG_NAME}"
          
          CMAKE_VERSION=$(grep -oP 'project\(.*?VERSION \K[0-9]+\.[0-9]+\.[0-9]+' CMakeLists.txt)
          echo "CMake Version: ${CMAKE_VERSION}"

          if [ "${TAG_NAME#v}" != "$CMAKE_VERSION" ]; then
            echo "::error::Version mismatch! Git tag is '${TAG_NAME}' but CMake version is '${CMAKE_VERSION}'."
            exit 1
          fi
          
          echo "version=${CMAKE_VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT

      # 步骤 4: 准备并生成发布文档
      - name: Generate Release Documents
        run: |
          cp CHANGELOG.md version.md
          echo "Created version.md"
          
          PDF_FILENAME="version-${{ steps.version_check.outputs.version }}.pdf"
          
          # 这条命令现在应该可以成功运行了
          pandoc version.md -o "${PDF_FILENAME}"
          echo "Generated ${PDF_FILENAME}"

      # 步骤 5: 创建 GitHub Release 并上传产物
      - name: Create GitHub Release and Upload Artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version_check.outputs.tag_name }}
          body_path: CHANGELOG.md
          files: |
            version.md
            version-*.pdf